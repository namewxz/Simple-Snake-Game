#include "word.hpp"
#include <cstdint>
#include <stdio.h>
// Font data definitions
const uint8_t WordDisplay::NAME_FU_FONT[] = {
    /*--  文字:  傅  --*/
    0x00,0x00,0x00,0x0E,0x1F,0x00,0x0E,0x1B,0xC0,0x0F,0xFF,0xE0,0x1C,0x18,0x00,0x1D,
    0xFF,0xC0,0x19,0x99,0xC0,0x3D,0xFF,0xC0,0x3D,0x99,0xC0,0x7D,0x99,0xC0,0xDD,0xFF,
    0xC0,0x1D,0x9B,0xC0,0x1D,0x9B,0xC0,0x1F,0xFF,0xE0,0x1C,0xE3,0x00,0x1C,0x73,0x00,
    0x1C,0x73,0x00,0x1C,0x1F,0x00,0x1C,0x07,0x00,0x00,0x00,0x00,
};

const uint8_t WordDisplay::NAME_TING_FONT[] = {
    /*--  文字:  婷  --*/
    0x00,0x00,0x00,0x1C,0x1C,0x00,0x1C,0x0E,0x40,0x1D,0xFF,0xE0,0x18,0x80,0x00,0xFF,
    0xFF,0xC0,0x3B,0x71,0x80,0x3F,0x7F,0x80,0x37,0x71,0x80,0x37,0xFF,0xE0,0x77,0xC0,
    0xE0,0x77,0xC0,0xC0,0x7E,0x7F,0xC0,0x3E,0x0E,0x00,0x1F,0x0E,0x00,0x1F,0x0E,0x00,
    0x3B,0x0E,0x00,0x70,0x7E,0x00,0xE0,0x1C,0x00,0x00,0x00,0x00,
};

const uint8_t WordDisplay::NUM_1_FONT[] = {
    /*--  文字:  1  --*/
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0C,0x00,0x3C,0x00,0x3C,0x00,0x0C,0x00,
    0x0C,0x00,0x0C,0x00,0x0C,0x00,0x0C,0x00,0x0C,0x00,0x0C,0x00,0x1E,0x00,0x3F,0x80,
    0x00,0x00,0x00,0x00,0x00,0x00,
};

const uint8_t WordDisplay::NUM_FONT[10][24*35/8] = {
    {
        /*--  文字:  0  --*/
        /*--  宋体26;  此字体下对应的点阵为：宽x高=18x35   --*/
        /*--  宽度不是8的倍数，现调整为：宽度x高度=24x35  --*/
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x03,0xF0,0x00,0x0F,0xBC,0x00,0x0E,0x1C,0x00,0x1E,0x1E,0x00,0x3C,0x0F,
        0x00,0x3C,0x0F,0x00,0x3C,0x0F,0x00,0x78,0x0F,0x00,0x78,0x07,0x80,0x78,0x07,0x80,
        0x78,0x07,0x80,0x78,0x07,0x80,0x78,0x07,0x80,0x78,0x07,0x80,0x78,0x07,0x80,0x78,
        0x07,0x80,0x78,0x0F,0x00,0x3C,0x0F,0x00,0x3C,0x0F,0x00,0x3C,0x0F,0x00,0x1E,0x1E,
        0x00,0x0E,0x1C,0x00,0x0F,0xF8,0x00,0x03,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    },
    {
        /*--  文字:  1  --*/
        /*--  宋体26;  此字体下对应的点阵为：宽x高=18x35   --*/
        /*--  宽度不是8的倍数，现调整为：宽度x高度=24x35  --*/
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x60,0x00,0x01,0xE0,0x00,0x1F,0xE0,0x00,0x0F,0xE0,0x00,0x01,0xE0,
        0x00,0x01,0xE0,0x00,0x01,0xE0,0x00,0x01,0xE0,0x00,0x01,0xE0,0x00,0x01,0xE0,0x00,
        0x01,0xE0,0x00,0x01,0xE0,0x00,0x01,0xE0,0x00,0x01,0xE0,0x00,0x01,0xE0,0x00,0x01,
        0xE0,0x00,0x01,0xE0,0x00,0x01,0xE0,0x00,0x01,0xE0,0x00,0x01,0xE0,0x00,0x01,0xE0,
        0x00,0x01,0xE0,0x00,0x03,0xF0,0x00,0x1F,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    },
    {
        /*--  文字:  2  --*/
        /*--  宋体26;  此字体下对应的点阵为：宽x高=18x35   --*/
        /*--  宽度不是8的倍数，现调整为：宽度x高度=24x35  --*/
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x07,0xF8,0x00,0x1F,0x3E,0x00,0x1C,0x1E,0x00,0x38,0x0F,0x00,0x38,0x0F,
        0x00,0x3C,0x0F,0x00,0x3C,0x0F,0x00,0x3C,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0E,0x00,
        0x00,0x1E,0x00,0x00,0x3C,0x00,0x00,0x78,0x00,0x00,0x70,0x00,0x01,0xE0,0x00,0x03,
        0xC0,0x00,0x03,0x80,0x00,0x07,0x00,0x00,0x0E,0x03,0x80,0x1C,0x03,0x00,0x38,0x07,
        0x00,0x70,0x0F,0x00,0x7F,0xFF,0x00,0x7F,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    },
    {
        /*--  文字:  3  --*/
        /*--  宋体26;  此字体下对应的点阵为：宽x高=18x35   --*/
        /*--  宽度不是8的倍数，现调整为：宽度x高度=24x35  --*/
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x07,0xF0,0x00,0x1E,0x7C,0x00,0x3C,0x1C,0x00,0x3C,0x1E,0x00,0x3C,0x0E,
        0x00,0x3C,0x0E,0x00,0x1C,0x0E,0x00,0x00,0x0E,0x00,0x00,0x1E,0x00,0x00,0x3C,0x00,
        0x00,0xF8,0x00,0x03,0xF0,0x00,0x00,0x7C,0x00,0x00,0x1E,0x00,0x00,0x0F,0x00,0x00,
        0x0F,0x00,0x00,0x0F,0x00,0x38,0x07,0x00,0x3C,0x0F,0x00,0x7C,0x0F,0x00,0x3C,0x0F,
        0x00,0x3C,0x1E,0x00,0x1E,0x7C,0x00,0x0F,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    },
    {
        /*--  文字:  4  --*/
        /*--  宋体26;  此字体下对应的点阵为：宽x高=18x35   --*/
        /*--  宽度不是8的倍数，现调整为：宽度x高度=24x35  --*/
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x3C,0x00,0x00,0x3C,0x00,0x00,0x7C,0x00,0x00,0x7C,0x00,0x00,0xFC,
        0x00,0x01,0xFC,0x00,0x01,0xBC,0x00,0x03,0xBC,0x00,0x07,0x3C,0x00,0x06,0x3C,0x00,
        0x0E,0x3C,0x00,0x1C,0x3C,0x00,0x18,0x3C,0x00,0x38,0x3C,0x00,0x70,0x3C,0x00,0x70,
        0x3C,0x00,0xFF,0xFF,0x80,0x00,0x3C,0x00,0x00,0x3C,0x00,0x00,0x3C,0x00,0x00,0x3C,
        0x00,0x00,0x3C,0x00,0x00,0x7C,0x00,0x03,0xFF,0x80,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    },
    {
        /*--  文字:  5  --*/
        /*--  宋体26;  此字体下对应的点阵为：宽x高=18x35   --*/
        /*--  宽度不是8的倍数，现调整为：宽度x高度=24x35  --*/
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x1F,0xFF,0x00,0x1F,0xFF,0x00,0x1C,0x00,0x00,0x18,0x00,0x00,0x18,0x00,
        0x00,0x18,0x00,0x00,0x18,0x00,0x00,0x18,0x00,0x00,0x19,0xF0,0x00,0x1F,0xFC,0x00,
        0x3F,0x3E,0x00,0x3C,0x1E,0x00,0x38,0x0F,0x00,0x00,0x0F,0x00,0x00,0x07,0x00,0x00,
        0x07,0x00,0x00,0x07,0x00,0x3C,0x07,0x00,0x7C,0x0F,0x00,0x7C,0x0F,0x00,0x38,0x0F,
        0x00,0x38,0x1E,0x00,0x1F,0x3C,0x00,0x07,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    },
    {
        /*--  文字:  6  --*/
        /*--  宋体26;  此字体下对应的点阵为：宽x高=18x35   --*/
        /*--  宽度不是8的倍数，现调整为：宽度x高度=24x35  --*/
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x03,0xFC,0x00,0x07,0x9E,0x00,0x0E,0x1E,0x00,0x1E,0x1F,0x00,0x1C,0x0E,
        0x00,0x3C,0x00,0x00,0x38,0x00,0x00,0x38,0x00,0x00,0x78,0x60,0x00,0x7B,0xFC,0x00,
        0x7F,0xFE,0x00,0x7E,0x0F,0x00,0x7C,0x0F,0x00,0x7C,0x07,0x80,0x78,0x07,0x80,0x78,
        0x07,0x80,0x78,0x07,0x80,0x78,0x07,0x80,0x3C,0x07,0x80,0x3C,0x07,0x00,0x3C,0x0F,
        0x00,0x1E,0x0E,0x00,0x0F,0xBC,0x00,0x07,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    },
    {
        /*--  文字:  7  --*/
        /*--  宋体26;  此字体下对应的点阵为：宽x高=18x35   --*/
        /*--  宽度不是8的倍数，现调整为：宽度x高度=24x35  --*/
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x3F,0xFF,0x80,0x3F,0xFF,0x00,0x3C,0x07,0x00,0x38,0x0E,0x00,0x30,0x0E,
        0x00,0x70,0x1C,0x00,0x00,0x1C,0x00,0x00,0x38,0x00,0x00,0x38,0x00,0x00,0x70,0x00,
        0x00,0x70,0x00,0x00,0xE0,0x00,0x00,0xE0,0x00,0x01,0xE0,0x00,0x01,0xC0,0x00,0x01,
        0xC0,0x00,0x03,0xC0,0x00,0x03,0xC0,0x00,0x03,0xC0,0x00,0x03,0xC0,0x00,0x03,0xC0,
        0x00,0x03,0xC0,0x00,0x03,0xC0,0x00,0x03,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    },
    {
        /*--  文字:  8  --*/
        /*--  宋体26;  此字体下对应的点阵为：宽x高=18x35   --*/
        /*--  宽度不是8的倍数，现调整为：宽度x高度=24x35  --*/
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x07,0xF8,0x00,0x1F,0x3C,0x00,0x3C,0x0E,0x00,0x38,0x0F,0x00,0x38,0x07,
        0x00,0x78,0x07,0x00,0x78,0x07,0x00,0x3C,0x07,0x00,0x3E,0x0E,0x00,0x1F,0x9E,0x00,
        0x0F,0xFC,0x00,0x07,0xF8,0x00,0x1F,0xFC,0x00,0x1C,0x7E,0x00,0x38,0x1F,0x00,0x78,
        0x0F,0x00,0x70,0x07,0x00,0x70,0x07,0x80,0x70,0x07,0x80,0x70,0x07,0x00,0x78,0x07,
        0x00,0x3C,0x0E,0x00,0x1F,0x3C,0x00,0x07,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    },
    {
        /*--  文字:  9  --*/
        /*--  宋体26;  此字体下对应的点阵为：宽x高=18x35   --*/
        /*--  宽度不是8的倍数，现调整为：宽度x高度=24x35  --*/
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x07,0xF0,0x00,0x1F,0x3C,0x00,0x3C,0x1E,0x00,0x38,0x0E,0x00,0x78,0x0F,
        0x00,0x78,0x0F,0x00,0x78,0x07,0x00,0x78,0x07,0x80,0x78,0x07,0x80,0x78,0x0F,0x80,
        0x78,0x0F,0x80,0x78,0x1F,0x80,0x3C,0x3F,0x80,0x1F,0xFF,0x80,0x0F,0xEF,0x00,0x00,
        0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x1E,0x00,0x1C,0x1E,0x00,0x3C,0x1C,
        0x00,0x3E,0x3C,0x00,0x1E,0xF8,0x00,0x0F,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    }
};

// void WordDisplay::displayWord(Screen& screen, int x0, int y0, int w, int h, const uint8_t wordArr[], uint32_t color) {
//     // Adjust color format to match screen (RGB)
//     // uint32_t adjustedColor = ((color & 0xFF0000) >> 16) |  // R
//     //                         (color & 0x00FF00) |          // G
//     //                         ((color & 0x0000FF) << 16);   // B
//     uint32_t adjustedColor = color;
    
//     printf("Displaying word at (%d,%d) size %dx%d, color: 0x%X (adjusted: 0x%X)\n", 
//            x0, y0, w, h, color, adjustedColor);
//     int pixelCount = 0;
    
//     for (int i = 0; i < w/8*h; i++) {
//         for (int j = 7; j >= 0; j--) {
//             if (wordArr[i] >> j & 1) {
//                 int x1 = x0 + i%(w/8)*8 + (7-j);
//                 int y1 = y0 + i/(w/8);
//                 // Ensure coordinates are within bounds
//                 if (x1 >= 0 && x1 < screen.getWidth() && y1 >= 0 && y1 < screen.getHeight()) {
//                     screen.fill_rect(x1, y1, 1, 1, adjustedColor);
//                     pixelCount++;
//                 }
//             }
//         }
//     }
    
//     printf("Displayed %d pixels (within bounds)\n", pixelCount);
// }
void WordDisplay::displayWord(Screen& screen, int x0, int y0, int w, int h, const uint8_t wordArr[], uint32_t color) {
    // 直接使用原始颜色值（屏幕类会处理格式转换）
    uint32_t adjustedColor = color;
    
    // 计算每行的字节数
    const int bytesPerRow = w / 8;
    
    // 确保字体数据宽度匹配
    if (bytesPerRow == 0) {
        printf("Error: Invalid width %d (must be multiple of 8)\n", w);
        return;
    }

    int pixelCount = 0;
    bool outOfBounds = false;
    
    for (int row = 0; row < h; row++) {
        for (int colByte = 0; colByte < bytesPerRow; colByte++) {
            // 获取当前字节
            const int byteIndex = row * bytesPerRow + colByte;
            const uint8_t byteVal = wordArr[byteIndex];
            
            // 处理字节中的每个位（从左到右，MSB到LSB）
            for (int bit = 7; bit >= 0; bit--) {
                // 计算当前像素坐标
                const int pixelX = x0 + colByte * 8 + (7 - bit);
                const int pixelY = y0 + row;
                
                // 检查是否在显示区域内
                if (pixelX >= x0 && pixelX < x0 + w && 
                    pixelY >= y0 && pixelY < y0 + h) {
                    
                    // 检查位是否被设置
                    if (byteVal & (1 << bit)) {
                        // 确保在屏幕边界内
                        if (pixelX >= 0 && pixelX < screen.getWidth() && 
                            pixelY >= 0 && pixelY < screen.getHeight()) {
                            screen.fill_rect(pixelX, pixelY, 1, 1, adjustedColor);
                            pixelCount++;
                        } else {
                            outOfBounds = true;
                        }
                    }
                }
            }
        }
    }
    
    // // 调试信息
    // if (outOfBounds) {
    //     printf("Warning: Some pixels drawn outside screen boundaries\n");
    // }
    // printf("Displayed word at (%d,%d) size %dx%d, color: 0x%X\n", 
    //        x0, y0, w, h, color);
    // printf("  Pixel count: %d, Bytes used: %d/%d\n", 
    //        pixelCount, bytesPerRow * h, bytesPerRow * h);
}
void WordDisplay::displayNumber(Screen& screen, int x0, int y0, int w, int h, int num, uint32_t color) {
    if (num == 0) { // 添加0的特殊处理
        displayWord(screen, x0, y0, w, h, NUM_FONT[0], color);
        return;
    }
    int temp_num[32] = {0};
    int i = 0;
    while (num != 0) {
        temp_num[i] = num % 10;
        num /= 10;
        i++;
    }
    
    int count = 0;
    for(i--; i >= 0; i--) {
        displayWord(screen, x0 + count*w, y0, w, h, NUM_FONT[temp_num[i]], color);
        count++;
    }
}

void WordDisplay::splitAndDisplayNumber(Screen& screen, int num, int high) {
    if (num == 0) {
        displayWord(screen, 0, high, 24, 35, NUM_FONT[0], 0xff0000);
        return;
    }

    int digits[32] = {0};
    int count = 0;
    int original_num = num;

    while (num > 0) {
        digits[count++] = num % 10;
        num /= 10;
    }

    int x_offset = 140;
    for (int i = count - 1; i >= 0; --i) {
        displayWord(screen, x_offset, high, 24, 35, NUM_FONT[digits[i]], 0xff0000);
        x_offset += 24;
    }
}
